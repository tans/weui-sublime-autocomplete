import sublime_plugin
import sublime

# The following 2 lines can be generated with parse.js
tachyons_classes = ["weui-icon-circle","weui-icon-download","weui-icon-info","weui-icon-safe-success","weui-icon-safe-warn","weui-icon-success","weui-icon-success-circle","weui-icon-success-no-circle","weui-icon-waiting","weui-icon-waiting-circle","weui-icon-warn","weui-icon-info-circle","weui-icon-cancel","weui-icon-search","weui-icon-clear","weui-icon-back","weui-icon-delete","weui-icon-success-no-circle-thin","weui-icon-arrow","weui-icon-arrow-bold","weui-icon-back-arrow","weui-icon-back-arrow-thin","weui-icon-close","weui-icon-close-thin","weui-icon-back-circle","weui-icon-clear:active","weui-icon_gallery-delete","weui-icon_msg","weui-icon_msg-primary","weui-hidden_abs","weui-hidden-space:empty:before","weui-a11y-combo","weui-a11y-combo__helper","weui-a11y-combo__content","weui-wa-hotarea-el","weui-wa-hotarea-el__wrp","weui-wa-hotarea","weui-wa-hotarea_before","weui-wa-hotarea_before:before","weui-wa-hotarea:after","weui-link","weui-link:visited","weui-link:active","weui-btn","weui-btn:before","weui-btn_loading):active:before","weui-btn_block","weui-btn_inline","weui-btn_default","weui-btn_disabled):visited","weui-btn_primary","weui-btn_warn","weui-btn_disabled","weui-btn[disabled]","weui-btn_loading","weui-loading","weui-primary-loading","weui-primary-loading:before","weui-btn_cell","weui-btn_cell:active","weui-btn_cell__icon","weui-btn_cell-default","weui-btn_cell-primary","weui-btn_cell-warn","weui-bottom-fixed-opr-page","weui-bottom-fixed-opr-page__content","weui-bottom-fixed-opr","weui-bottom-fixed-opr:before","weui-btn:nth-last-child(n+2)","weui-btn:nth-last-child(n+2):first-child","weui-btn:first-child","weui-btn:nth-last-child(n+2):last-child","weui-btn:last-child","weui-bottom-fixed-opr-page_btn-wrap","weui-half-screen-dialog_bottom-fixed","weui-half-screen-dialog__hd","weui-half-screen-dialog__bd","weui-half-screen-dialog__ft","weui-btn:focus","weui-btn_mini","weui-btn_xmini","weui-btn-area","weui-btn-area_inline","weui-btn_reset","weui-btn_icon","weui-btn_icon:active","weui-cells","weui-cells:before","weui-cells:after","weui-cells__title","weui-cells__tips","weui-cell","weui-cell:before","weui-cell:first-child:before","weui-cell_active:active:after","weui-cell_primary","weui-cell__bd","weui-cell__ft","weui-cell__desc","weui-cell_swiped","weui-swiped-btn","weui-swiped-btn_default","weui-swiped-btn_warn","weui-cell_access","weui-cell_access:active:after","weui-cell__ft:after","weui-cell_link","weui-cell_link:first-child:before","weui-check__label","weui-cell_readonly","weui-cell_disabled","weui-check","weui-icon-checked","weui-cells_radio","weui-cells_checkbox","weui-check__label:before","weui-cell__hd","weui-label","weui-input","weui-input::-webkit-outer-spin-button","weui-input::-webkit-inner-spin-button","weui-btn_input-clear","weui-textarea","weui-textarea-counter","weui-cell_warn","weui-input:disabled","weui-textarea:disabled","weui-input[disabled]","weui-textarea[disabled]","weui-input[readonly]","weui-textarea[readonly]","weui-cells_form","weui-cell_switch:active","weui-cell_vcode:active","weui-cell_readonly:active","weui-cell_disabled:active","weui-form-preview","weui-form-preview:before","weui-form-preview:after","weui-form-preview__hd","weui-form-preview__hd:after","weui-form-preview__value","weui-form-preview__bd","weui-form-preview__ft","weui-form-preview__ft:before","weui-form-preview__item","weui-form-preview__label","weui-form-preview__btn","weui-form-preview__btn:active","weui-form-preview__btn:after","weui-form-preview__btn:first-child:after","weui-form-preview__btn_default","weui-form-preview__btn_primary","weui-form-preview__list","weui-form-preview__list:before","weui-form-preview__list:last-child","weui-form-preview__item:first-child","weui-cells__title:first-child","weui-cell_select","weui-cell__bd:after","weui-select","weui-cell_select-before","weui-cell__hd:after","weui-cell__hd:before","weui-cell_select-after","weui-cell_vcode","weui-vcode-img","weui-vcode-btn","weui-vcode-btn:before","weui-vcode-btn:active","weui-gallery","weui-gallery__img","weui-gallery__opr","weui-gallery__del","weui-gallery__del:active","weui-cell_switch","weui-switch","weui-switch-cp__box","weui-switch:after","weui-switch-cp__box:after","weui-switch:checked","weui-switch:checked:after","weui-switch[disabled]","weui-switch-cp__input","weui-cell_uploader","weui-uploader","weui-uploader__hd","weui-uploader__title","weui-uploader__info","weui-uploader__bd","weui-uploader__files","weui-uploader__file","weui-uploader__file_status","weui-uploader__file_status:before","weui-uploader__file-content","weui-uploader__input-box","weui-uploader__input-box:before","weui-uploader__input-box:after","weui-uploader__input-box:active:before","weui-uploader__input-box:active:after","weui-uploader__input","weui-msg__desc","weui-msg__desc-primary","weui-msg__tips","weui-msg","weui-msg__icon-area","weui-msg__text-area","weui-msg__text-area:first-child","weui-msg__title","weui-msg__custom-area","weui-cells__group_form","weui-msg__opr-area","weui-msg__opr-area:last-child","weui-msg__extra-area","weui-msg__tips-area","weui-msg__tips-area:last-child","weui-msg_align-top","weui-steps","weui-steps__item__title","weui-steps__item__desc","weui-steps_vertical","weui-steps__item","weui-steps__item:before","weui-steps__item_success)","weui-steps__item__inner:before","weui-steps__item:last-child:before","weui-steps__item__inner","weui-steps__icon","weui-steps__item_icon:before","weui-steps__item_icon","weui-steps__item_icon-prev:before","weui-steps__item_success:before","weui-steps__item_success","weui-steps_horizonal","weui-steps__item:after","weui-steps__item:last-child","weui-steps__item:last-child:after","weui-steps__item_success):before","weui-steps__item_success:after","weui-steps_horizonal-primary","weui-steps__item__inner:after","weui-steps_horizonal-center","weui-steps__item:first-child:before","weui-cells__group","weui-cells__group:first-child","weui-cells__group_form:first-child","weui-cells__tips_warn","weui-cell_switch:active:after","weui-cell_vcode:active:after","weui-cell_readonly:active:after","weui-cell_disabled:active:after","weui-cell_wrap","weui-cell__control","weui-cell__control_flex","weui-cells__group_form-primary","weui-form","weui-footer","weui-footer__link","weui-agree","weui-agree__checkbox","weui-agree__text","weui-form__text-area","weui-form__control-area","weui-form__tips-area","weui-form__extra-area","weui-form__opr-area","weui-form__opr-area:last-child","weui-form__tips-area:last-child","weui-form__title","weui-form__desc","weui-form__tips","weui-article","weui-article__list_inside","weui-article__list_none","weui-tabbar","weui-tabbar:before","weui-tabbar__item","weui-tabbar__item:first-child","weui-tabbar__item:last-child","weui-bar__item_on","weui-tabbar__icon","weui-tabbar__icon>i","weui-tabbar__label","weui-navbar","weui-navbar:after","weui-tab__panel","weui-navbar__item","weui-navbar__item:active","weui-navbar__item:after","weui-navbar__item:first-child","weui-navbar__item:last-child","weui-navbar__item:last-child:after","weui-tab","weui-tab__content","weui-progress","weui-progress__bar","weui-progress__inner-bar","weui-progress__opr","weui-panel","weui-panel:first-child","weui-panel:before","weui-panel:after","weui-panel__hd","weui-panel__hd:after","weui-media-box","weui-media-box:before","weui-media-box:first-child:before","weui-media-box:active","weui-media-box__title","weui-media-box__desc","weui-media-box__info","weui-media-box__info__meta","weui-media-box__info__meta_extra","weui-media-box_appmsg","weui-media-box__hd","weui-media-box__thumb","weui-media-box__bd","weui-media-box_small-appmsg","weui-grids","weui-grids:before","weui-grids:after","weui-grid","weui-grid:before","weui-grid:after","weui-grid:active","weui-grid__icon","weui-grid__label","weui-footer_fixed-bottom","weui-footer__links","weui-footer__link:before","weui-footer__link:first-child:before","weui-footer__text","weui-flex","weui-flex__item","weui-dialog","weui-dialog__hd","weui-dialog__title","weui-dialog__bd","weui-dialog__bd:first-child","weui-dialog__ft","weui-dialog__ft:after","weui-dialog__btn","weui-dialog__btn:active","weui-dialog__btn:after","weui-dialog__btn:first-child:after","weui-dialog__btn_default","weui-skin_android","weui-dialog__btn:last-child","weui-half-screen-dialog","weui-icon-btn","weui-icon-btn:active","weui-half-screen-dialog__hd__side","weui-half-screen-dialog__hd__main","weui-half-screen-dialog__title","weui-half-screen-dialog__subtitle","weui-half-screen-dialog__desc","weui-half-screen-dialog__tips","weui-half-screen-dialog__btn-area","weui-half-screen-dialog__attachment-area","weui-half-screen-dialog_btn-wrap","weui-half-screen-dialog_large","weui-half-screen-dialog_slide","weui-half-screen-dialog__slide-icon","weui-icon-more","weui-icon-slide-down","weui-icon-btn_goback","weui-icon-btn_close","weui-toast","weui-toast_text","weui-toast__content","weui-icon_toast","weui-primary-loading:after","weui-primary-loading__dot","weui-toast_text-more","weui-mask","weui-mask_transparent","weui-actionsheet","weui-actionsheet__title","weui-actionsheet__title:before","weui-actionsheet__title-text","weui-actionsheet__menu","weui-actionsheet__action","weui-actionsheet__cell:last-child","weui-actionsheet__cell","weui-actionsheet__cell:before","weui-actionsheet__cell:active","weui-actionsheet__cell:first-child:before","weui-actionsheet__cell_warn","weui-actionsheet__cell:first-child","weui-actionsheet_toggle","weui-loadmore","weui-loadmore__tips","weui-loadmore_line","weui-loadmore_dot","weui-loadmore__tips:before","weui-badge","weui-badge_dot","weui-toptips","weui-toptips_warn","weui-list-tips","weui-list-tips:before","weui-list-tips:last-child","weui-list-tips__item","weui-list-tips__item:before","weui-list-tips__item:first-child","weui-search-bar","weui-search-bar_focusing","weui-search-bar__cancel-btn","weui-search-bar__label","weui-search-bar__form","weui-search-bar__box","weui-search-bar__input","weui-search-bar__input:focus","weui-icon-clear:after","weui-picker","weui-picker__hd","weui-picker__hd:after","weui-picker__bd","weui-picker__group","weui-picker__group:first-child","weui-picker__item","weui-picker__group:last-child","weui-picker__mask","weui-picker__indicator","weui-picker__indicator:before","weui-picker__indicator:after","weui-picker__content","weui-picker__item_disabled","weui-animate_slide-up","weui-animate-slide-up","weui-animate_slide-down","weui-animate-slide-down","weui-animate_fade-in","weui-animate-fade-in","weui-animate_fade-out","weui-animate-fade-out","weui-agree__checkbox-check","weui-agree__checkbox:checked","weui-agree_animate","weui-primary-loading_brand","weui-primary-loading_transparent","weui-loading_transparent","weui-slider","weui-slider__inner","weui-slider__track","weui-slider__handler","weui-slider-box","weui-slider-box__value"]



class WeuiCompletions(sublime_plugin.EventListener):
    def __init__(self):

        self.class_completions = [("%s \tWeui Class" % s, s) for s in tachyons_classes]

    def on_query_completions(self, view, prefix, locations):

        if view.match_selector(locations[0], "text.html string.quoted"):

            # Cursor is inside a quoted attribute
            # Now check if we are inside the class attribute

            # max search size
            LIMIT  = 250

            # place search cursor one word back
            cursor = locations[0] - len(prefix) - 1

            # dont start with negative value
            start  = max(0, cursor - LIMIT - len(prefix))

            # get part of buffer
            line   = view.substr(sublime.Region(start, cursor))

            # split attributes
            parts  = line.split('=')

            # is the last typed attribute a class attribute?
            if len(parts) > 1 and parts[-2].strip().endswith("class"):
                return self.class_completions
            else:
                return []
        elif view.match_selector(locations[0], "text.html meta.tag - text.html punctuation.definition.tag.begin"):

            # Cursor is in a tag, but not inside an attribute, i.e. <div {here}>
            # This one is easy, just return completions for the data-uk-* attributes
            return self.data_completions

        else:

            return []
